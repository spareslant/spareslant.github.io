<!DOCTYPE html>
<html class="no-js" lang="en-gb">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Apache ReverseProxySSL SSLClientAuth - SpareSlant Technical Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/my.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="SpareSlant Technical Blog" rel="home">
				<div class="logo__title">SpareSlant Technical Blog</div>
				<div class="logo__tagline">SpareSlant tech blog</div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Apache ReverseProxySSL SSLClientAuth</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-08-04T14:54:01">2019-08-04</time>
</div>
</div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#environment-used">Environment Used</a></li>
<li><a href="#prepare-environment">Prepare Environment</a>
<ul>
<li><a href="#create-python-virtual-environment">Create python virtual environment</a></li>
<li><a href="#create-all-digital-certificates">Create all digital certificates</a>
<ul>
<li><a href="#create-client-side-certificate">Create client-side certificate</a></li>
<li><a href="#create-apache-server-side-certificate">Create <code>apache</code> server-side certificate</a></li>
<li><a href="#create-apache-client-side-certificate">Create <code>apache</code> client-side certificate</a></li>
<li><a href="#create-gunicorn-server-side-certificate">Create <code>gunicorn</code> server-side certificate</a></li>
</ul></li>
<li><a href="#apache-preparation">Apache Preparation</a>
<ul>
<li><a href="#create-certificate-directory">Create Certificate Directory</a></li>
<li><a href="#prepare-certificate-to-be-used-by-apache-reverse-proxy-ssl-engine">prepare certificate to be used by apache reverse proxy SSL engine.</a></li>
<li><a href="#prepeare-apache-config-file">Prepeare apache config file</a></li>
<li><a href="#start-apache">Start Apache</a></li>
<li><a href="#make-client-apache-and-gunicorn-addresses-resolvable">Make client, apache and gunicorn addresses resolvable</a></li>
<li><a href="#create-a-simple-flask-app">Create a Simple flask app</a></li>
<li><a href="#create-client-environment">Create client environment</a></li>
<li><a href="#test-the-whole-setup">Test the whole setup</a>
<ul>
<li><a href="#test-gunicorn-server-connectivity-directly">Test <code>gunicorn</code> server connectivity directly</a></li>
<li><a href="#test-gunicorn-server-connectivity-directly-no-certs-insecure">Test <code>gunicorn</code> server connectivity directly (no certs, insecure)</a></li>
<li><a href="#insecure-connection-attempt"><code>insecure</code> connection attempt</a></li>
<li><a href="#authenticated-connection-attempt">Authenticated connection attempt.</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			

<h1 id="introduction">Introduction</h1>

<p>We will be configuring <code>Apache</code> in reverse proxy mode. <code>Apache</code> will be accepting connections on secure port with SSL client authentication and forward that request to a backend application server <code>Gunicorn</code>. Communication between <code>apache</code> and <code>gunicorn</code> will also be on secure port and SSL authenticated. <code>Gunicorn</code> will run a simple <code>flask</code> app that will be writing some text to file.</p>

<p>Purpose of this excersize is to introduce end to end secure communication from client to apache to app server with SSL client authentication at every stage. Please note that this exercise represents just the minimal configuration to work and no other authentication mechanism will be mentioned.</p>

<p><strong>Note:</strong> we will be using self-signed CA authority and all certificates will be signed by this authority.</p>

<h1 id="environment-used">Environment Used</h1>

<pre><code class="language-bash">$ cat /etc/fedora-release
Fedora release 30 (Thirty)

$ uname -a
Linux localhost.localdomain 5.0.9-301.fc30.x86_64 #1 SMP Tue Apr 23 23:57:35 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>

<h1 id="prepare-environment">Prepare Environment</h1>

<h2 id="create-python-virtual-environment">Create python virtual environment</h2>

<pre><code class="language-bash">$ python3 -m  venv apacheSLL
$ source apacheSLL/bin/activate
$ pip install flask
$ pip install gunicorn
</code></pre>

<h2 id="create-all-digital-certificates">Create all digital certificates</h2>

<p>We will be using a PKI setup mentioned in <a href="/posts/ssl-certificate/"><strong>this link</strong></a>
We will be creating following certificates.</p>

<ul>
<li>client-side certificate used by <code>curl</code></li>
<li>apache server-side certificate used in interfacing with client.</li>
<li>apache client-certificate used in interfacing with <code>gunicorn</code></li>
<li><code>gunicorn</code> server-side certificate.</li>
</ul>

<h3 id="create-client-side-certificate">Create client-side certificate</h3>

<p>create CSR</p>

<pre><code class="language-bash">openssl req \
-config &lt;(cat opensslConf/csr_openssl.cnf opensslConf/client_san_names.cnf) \
-new \
-newkey rsa:2048 \
-nodes \
-days 365 \
-out CSRs/aClient.csr \
-keyout privateKeys/aClientKey.pem \
-reqexts client \
-subj &quot;/emailAddress=client@somecompany.com/C=GB/ST=London/L=City of London/O=client Organization/OU=Engg/CN=client.full.domain.name&quot;
</code></pre>

<p>Sign CSR with CA</p>

<pre><code class="language-bash">openssl ca \
-config opensslConf/CA_openssl.cnf \
-policy policy_anything \
-cert caCert/myCA.crt \
-keyfile caCert/myCAkey.pem \
-in CSRs/aClient.csr \
-out newCreatedCerts/aClientCert.pem
</code></pre>

<h3 id="create-apache-server-side-certificate">Create <code>apache</code> server-side certificate</h3>

<p>If you have followed the structure of PKI mentioned in <a href="/posts/ssl-certificate/"><strong>this link</strong></a>, then create a san file for apache like following.</p>

<pre><code class="language-bash">$ cat opensslConf/apache_san_names.cnf
[ san_names ]
DNS.1 = apache.server.name
</code></pre>

<p>create CSR</p>

<pre><code class="language-bash">openssl req \
-config &lt;(cat opensslConf/csr_openssl.cnf opensslConf/apache_san_names.cnf) \
-new \
-newkey rsa:2048 \
-nodes \
-days 365 \
-out CSRs/apacheServer.csr \
-keyout privateKeys/apacheServerKey.pem \
-reqexts server \
-subj &quot;/emailAddress=apacheAdmin@admin.com/C=GB/ST=London/L=City of London/O=My Organization/OU=Engg/CN=apache.server.name&quot;
</code></pre>

<p>Sign CSR with CA</p>

<pre><code class="language-bash">openssl ca \
-config opensslConf/CA_openssl.cnf \
-policy policy_anything \
-cert caCert/myCA.crt \
-keyfile caCert/myCAkey.pem \
-in CSRs/apacheServer.csr \
-out newCreatedCerts/apacheServerCert.pem
</code></pre>

<h3 id="create-apache-client-side-certificate">Create <code>apache</code> client-side certificate</h3>

<p>create CSR</p>

<pre><code class="language-bash">openssl req \
-config &lt;(cat opensslConf/csr_openssl.cnf opensslConf/apache_san_names.cnf) \
-new \
-newkey rsa:2048 \
-nodes \
-days 365 \
-out CSRs/apacheAsClient.csr \
-keyout privateKeys/apacheAsClientKey.pem \
-reqexts client \
-subj &quot;/emailAddress=apacheAdmin@admin.com/C=GB/ST=London/L=City of London/O=My Organization/OU=Engg/CN=apache.server.name&quot;
</code></pre>

<p>Sign CSR with CA</p>

<pre><code class="language-bash">openssl ca \
-config opensslConf/CA_openssl.cnf \
-policy policy_anything \
-cert caCert/myCA.crt \
-keyfile caCert/myCAkey.pem \
-in CSRs/apacheAsClient.csr \
-out newCreatedCerts/apacheAsClientCert.pem
</code></pre>

<h3 id="create-gunicorn-server-side-certificate">Create <code>gunicorn</code> server-side certificate</h3>

<p>If you have followed the structure of PKI mentioned in <a href="/posts/ssl-certificate/"><strong>this link</strong></a>, then create a san file for gunicorn like following.</p>

<pre><code class="language-bash">$ cat opensslConf/gunicorn_san_names.cnf

[ san_names ]
DNS.1 = gunicorn.app.server
</code></pre>

<pre><code class="language-bash">$ openssl req \
-config &lt;(cat opensslConf/csr_openssl.cnf opensslConf/gunicorn_san_names.cnf) \
-new \
-newkey rsa:2048 \
-nodes \
-days 365 \
-out CSRs/gunicornServer.csr \
-keyout privateKeys/gunicornServerKey.pem \
-reqexts server \
-subj &quot;/emailAddress=apacheAdmin@admin.com/C=GB/ST=London/L=City of London/O=My Organization/OU=Engg/CN=gunicorn.app.server&quot;
</code></pre>

<p>Sign CSR</p>

<pre><code class="language-bash">$ openssl ca \
-config opensslConf/CA_openssl.cnf \
-policy policy_anything \
-cert caCert/myCA.crt \
-keyfile caCert/myCAkey.pem \
-in CSRs/gunicornServer.csr \
-out newCreatedCerts/gunicornCert.pem
</code></pre>

<p>In whole, following files will should be created.</p>

<pre><code class="language-bash">$ ls -1 caCert newCreatedCerts privateKeys/
caCert:
myCA.crt
myCAkey.pem

newCreatedCerts:
12.pem
13.pem
14.pem
15.pem
aClientCert.pem
apacheAsClientCert.pem
apacheServerCert.pem
gunicornCert.pem

privateKeys/:
aClientKey.pem
apacheAsClientKey.pem
apacheServerKey.pem
gunicornServerKey.pem
</code></pre>

<p><strong>Note:</strong> you will never need <code>myCAkey.pem</code> file except for signing CSRs. Also ignore pem files having numerals in their names. Each certification generation process creates a cert file and a corresponding numeral file. Contents of both the files are same. Hence can be ignored.</p>

<h2 id="apache-preparation">Apache Preparation</h2>

<p>Make sure <code>apache</code> is installed. In case of fedora apache is recognized as <code>httpd</code> rpm package.</p>

<p>Install apache <code>ssl</code> module.</p>

<pre><code class="language-bash">$ sudo dnf -y install mod_ssl
</code></pre>

<h3 id="create-certificate-directory">Create Certificate Directory</h3>

<pre><code class="language-bash">$ sudo mkdir /etc/httpd/sslCerts
$ sudo cp newCreatedCerts/apacheServerCert.pem newCreatedCerts/apacheAsClientCert.pem \
privateKeys/apacheServerKey.pem privateKeys/apacheAsClientKey.pem \
caCert/myCA.crt \
/etc/httpd/sslCerts/
</code></pre>

<h3 id="prepare-certificate-to-be-used-by-apache-reverse-proxy-ssl-engine">prepare certificate to be used by apache reverse proxy SSL engine.</h3>

<pre><code class="language-bash">$ openssl rsa -in apacheAsClientKey.pem &gt; apacheAsClientKeyWithRSAHeader.pem
$ openssl x509 -in apacheAsClientCert.pem &gt; apacheAsClientCertPEMformat.pem
$ cat apacheAsClientCertPEMformat.pem apacheAsClientKeyWithRSAHeader.pem &gt; apacheAsClientCertAndKeyCombined.pem
$ chmod 400 apacheServerKey.pem apacheAsClientCertAndKeyCombined.pem
</code></pre>

<p><strong>Note:</strong> We do NOT need <code>apacheAsClientKey.pem</code>, <code>apacheAsClientCert.pem</code>, <code>apacheAsClientKeyWithRSAHeader.pem</code> and <code>apacheAsClientCertPEMformat.pem</code> files and they can be deleted.</p>

<h3 id="prepeare-apache-config-file">Prepeare apache config file</h3>

<p>Create a file <code>/etc/httpd/conf.d/reverseProxy.conf</code> with following contents.</p>

<pre><code class="language-bash">$ cat /etc/httpd/conf.d/reverseProxy.conf

Listen 7771
&lt;VirtualHost *:7771&gt;
    ServerName apache.server.name
    # LogLevel debug

    SSLEngine On
    SSLCACertificateFile /etc/httpd/sslCerts/myCA.crt
    SSLCertificateFile /etc/httpd/sslCerts/apacheServerCert.pem
    SSLCertificateKeyFile /etc/httpd/sslCerts/apacheServerKey.pem
    SSLVerifyClient require
    SSLVerifyDepth 5

    SSLProxyEngine On
    SSLProxyVerify require
    SSLProxyVerifyDepth 5
    # SSLProxyCheckPeerCN Off
    SSLProxyCheckPeerName Off
    SSLProxyCACertificateFile /etc/httpd/sslCerts/myCA.crt
    SSLProxyMachineCertificateFile /etc/httpd/sslCerts/apacheAsClientCertAndKeyCombined.pem

    &lt;Location &quot;/&quot;&gt;
        ProxyPreserveHost On
        ProxyPass &quot;https://gunicorn.app.server:6662/&quot;
        # SSLRequireSSL
        # SSLRequire %{SSL_CLIENT_S_DN_CN} eq &quot;some.host.name&quot;
        # SSLRequire %{SSL_CLIENT_SAN_DNS_0} eq &quot;some.host.name&quot;
        # SSLRequire %{REMOTE_HOST} in {&quot;some.host.name&quot;, &quot;another.host.name&quot;}
    &lt;/Location&gt;

&lt;/VirtualHost&gt;
</code></pre>

<p><strong>Note</strong>: You may need to inrease <code>SSLVerifyDepth</code> and <code>SSLProxyVerifyDepth</code> to higher number. This represents the depth of you certificate chain (Root and intermediary certs). Number need to be exact. It can be higher but no lower. Lower number will result in error.</p>

<h3 id="start-apache">Start Apache</h3>

<pre><code class="language-bash">$ sudo systemctl restart  httpd
</code></pre>

<p><strong>Note:</strong> You may need to tweak selinux policy for apache to run at 7771 port. I had disabled selinux for this excersize.</p>

<h3 id="make-client-apache-and-gunicorn-addresses-resolvable">Make client, apache and gunicorn addresses resolvable</h3>

<p>As <code>root</code> user enter the following line in <code>/etc/resolv.conf</code> file above all <code>nameserver</code> lines.</p>

<pre><code>nameserver 127.0.0.1
</code></pre>

<p>Run a temp DNS server in foreground.</p>

<pre><code class="language-bash">$ sudo dnsmasq --no-daemon \
--listen-address=127.0.0.1 \
--address=/client.full.domain.name/127.0.0.1 \
--address=/apache.server.name/127.0.0.1 --address=/gunicorn.app.server/127.0.0.1  \
--log-queries
</code></pre>

<h3 id="create-a-simple-flask-app">Create a Simple flask app</h3>

<pre><code class="language-bash">mkdir flaskApp
mkdir flaskApp/certs
touch flaskApp/myFlaskApp.py
</code></pre>

<p>Contents of <code>flaskApp/certs</code> should be following</p>

<pre><code class="language-bash">$ ls -og flaskApp/certs
total 16
-rw-rw-r--. 1 5021 Aug  4 17:37 gunicornCert.pem
-rw-------. 1 1704 Aug  4 17:37 gunicornServerKey.pem
-rw-rw-r--. 1 1493 Aug  4 17:37 myCA.crt
</code></pre>

<p>Contents of <code>myFlaskApp.py</code> are below.</p>

<pre><code class="language-bash">$ cat myFlaskApp.py
from flask import Flask, jsonify
app = Flask(__name__)

api_url = &quot;/&quot;

@app.route(api_url, methods=[&quot;GET&quot;])
def write_to_file():
    return jsonify({&quot;success&quot;: &quot;request received successfully&quot;}), 201
</code></pre>

<p>start serving flask app using following command.</p>

<pre><code class="language-bash">$ cd flaskApp/
$ gunicorn --bind 0.0.0.0:6662 myFlaskApp:app \
--ca-certs certs/myCA.crt \
--certfile certs/gunicornCert.pem \
--keyfile certs/gunicornServerKey.pem \
--cert-reqs 2

[2019-08-04 18:20:48 +0100] [37404] [INFO] Starting gunicorn 19.9.0
[2019-08-04 18:20:48 +0100] [37404] [INFO] Listening at: https://0.0.0.0:6662 (37404)
[2019-08-04 18:20:48 +0100] [37404] [INFO] Using worker: sync
[2019-08-04 18:20:48 +0100] [37407] [INFO] Booting worker with pid: 37407
</code></pre>

<p><strong>Note:</strong> argument 2 for <code>--cert-reqs</code> corresponds to <code>ssl.CERT_REQUIRED</code></p>

<h3 id="create-client-environment">Create client environment</h3>

<pre><code class="language-bash">$ mkdir client
$ mkdir client/certs
</code></pre>

<p>contents of <code>client/certs</code> are below</p>

<pre><code class="language-bash">$ ls -og client/certs/
total 16
-rw-rw-r--. 1 5062 Aug  4 17:40 aClientCert.pem
-rw-------. 1 1704 Aug  4 17:41 aClientKey.pem
-rw-rw-r--. 1 1493 Aug  4 17:41 myCA.crt
</code></pre>

<h3 id="test-the-whole-setup">Test the whole setup</h3>

<h4 id="test-gunicorn-server-connectivity-directly">Test <code>gunicorn</code> server connectivity directly</h4>

<p>Gunicorn server connectivity.</p>

<pre><code class="language-bash">$ curl https://gunicorn.app.server:6662 \
--cacert certs/myCA.crt \
--cert certs/aClientCert.pem \
--key certs/aClientKey.pem 

{&quot;success&quot;:&quot;request received successfully&quot;}
</code></pre>

<h4 id="test-gunicorn-server-connectivity-directly-no-certs-insecure">Test <code>gunicorn</code> server connectivity directly (no certs, insecure)</h4>

<pre><code class="language-bash">$ curl https://gunicorn.app.server:6662 \
--cacert certs/myCA.crt \
--insecure

curl: (56) OpenSSL SSL_read: error:1409445C:SSL routines:ssl3_read_bytes:tlsv13 alert certificate required, errno 0
</code></pre>

<h4 id="insecure-connection-attempt"><code>insecure</code> connection attempt</h4>

<p>insecure connection</p>

<pre><code class="language-bash">$ cd client/
$ curl https://apache.server.name:7771/ --insecure

curl: (56) OpenSSL SSL_read: error:1409445C:SSL routines:ssl3_read_bytes:tlsv13 alert certificate required, errno 0
</code></pre>

<p>Above connection failed because server requires authentication. Client also need to provide its certificate.</p>

<h4 id="authenticated-connection-attempt">Authenticated connection attempt.</h4>

<pre><code class="language-bash">$ curl https://apache.server.name:7771/ \
--cacert certs/myCA.crt \
--cert certs/aClientCert.pem \
--key certs/aClientKey.pem 

{&quot;success&quot;:&quot;request received successfully&quot;}
</code></pre>

<p><strong>Note</strong>: You do not need to generate so many certificates. You can generate certificate having both the extensions of <code>TLS Web Server Authentication</code> and <code>TLS client Authentication</code> and that certificate can be deployed at all places.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/apache/" rel="tag">apache</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/ssl/" rel="tag">SSL</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/proxy/" rel="tag">proxy</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/reverse-proxy/" rel="tag">reverse proxy</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/ssl-reverse-proxy/" rel="tag">SSL reverse proxy</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/gunicorn/" rel="tag">gunicorn</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/ssl-authentication/" rel="tag">SSL authentication</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/flask/" rel="tag">flask</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<div class="authorbox__header">
		<span class="authorbox__name">About SpareSlant</span>
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/posts/deploy-hugosite-to-github/" rel="prev"><span class="post-nav__caption">Â«&thinsp;Previous</span><p class="post-nav__post-title">Deploy HugoSite to Github</p></a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 SpareSlant.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script></body>
</html>